
# 多个样本均数比较的方差分析


T检验只能比较两组样本均值，对于多组的样本处理就需要用方差分析(Analysis of variance. ANOVA)。

在进行科学研究时，有时要按实验(对人称为试验)设计将所研究的对象分为多个处理组施加不同的干预(比如治疗某种疾病的方式)，施加的干预为处理， 处理因素(Treatment，如用药处理，手术处理，药品剂量等)至少有两个水平(Level，比如药物种类有A，B，C三种，即为3个水平)。这类科研资料的统计分析， 是通过所获得的样本信息来推断各处理组均数 间的差别是否有统计学意义，即处理有无效果。常采用 的统计分析方法为方差分析，由英国统计学家R. A. Fisher 首创， 为纪念 Fisher.以F命名，故方差分析又称F检验，也称为 “变异数分析”。

F检验与前面的t检验或者Z检验类似，也有自己的概率分布基础，即方差分析是依靠F-分布为概率分布的依据， 利用离均差平方和(Sum of square of deviations from mean,SS)与自由度(Degree of freedom, df)所计算的组间与组内均方(Mean of square,MS)估计出F值和P值，结合检验水准 
α=0.05
 判断检验结果。 若有统计学意义( P值≤0.05 )，则拒绝原假设 H0(μ0=μ1=μ2=μ3
=⋯) ，接受 H1 ( μ 不完全相等)，即各样本不是来自不完全相同的总体； 反之，若没有统计学意义( P值>0.05 )，则不拒绝原假设 H
0(μ0=μ1=μ2=μ3=⋯)，即还不能确定各样本是来自不完全相同的总体；

## F分布

F分布定义是设 X、 Y为两个独立的随机变量， 
X服从自由度为k1的卡方分布，Y服从自由度为k2的卡方分布，这两个独立的卡方分布除以各自的自由度后的比率这一统计量的分布，即服从F-分布（F-distribution）。

在R语言中。F-分布也有几个与Z分布，t分布基本函数类似的工具函数，分别是df()，pf()，qf()和rf()。
```{r fig.cap='F-分布的概率密度曲线测试'}
f_val = 2.2
df1 = 10
df2 = 20
q_seq <- c(0.25, 0.5, 0.75, 0.999)

df(f_val, df1 = df1, df2 = df2)

pf(f_val, df = df1, df2 = df2, lower.tail = TRUE)

qf(q_seq, df1 = df1, df2 = df2, lower.tail = TRUE)


x <- rf(100000, df1 = df1, df2 = df2)
hist(x, col="#A8D6FF",
     breaks = 'Scott', freq = FALSE, 
     xlim = c(0,3), ylim = c(0,1),
     xlab = '', main = 'Histogram for a F-distribution with df1=10, df2=20', cex.main=0.9)

curve(df(x, df1 = df1, df2 = df2), from = 0, to = 3, n = 10000, col= 'red', lwd=2, add = T)
```



## F检验的分类、原理及应用


按方差分析的基本运算概念，依照所感兴趣的因子数量而可分三大类：

     1. 单因子方差分析(One-way ANOVA)
     2. 双因子方差分析(Two-way ANOVA)
     3. 多因子方差分析(Multi-way ANOVA)

如果依照因子的特性不同而有三种型态，分别是：

    1. 固定效应方差分析(Fixed-effect ANOVA)
    2. 随机效应方差分析(Random-effect ANOVA)
    3. 混合效应方差分析(Mixed-effect ANOVA)

一般的，按照因子数量的分类进行区分使用情况比较常见，这里借用单因素方差分析(One-way ANOVA)介绍方差分析的基本思想


ANOVA通过分析方差来推断均值是否和总体有显著性差异(注意：虽然叫做方差分析，但是它的目的是检验每个组的平均数是否相同)。 ANOVA把方差分为处理因素(Treatment effect，真实差异)和误差(Error effect，抽样误差或个体差异)两个来源，两个方差的比值服从F分布，因为方差本身 就是个体和均值差平方和，所以对方差组成的分析能够反映均值的差异。处理效应(Treatment effect)是不同组的均值间的差异，误差(Error effect)是组内 个体间的差异，习惯性地称前者为组间(Between)差异，后者为组内(Wthin)差异。

例如，在工业生产或实验研究中，为了比较药物X，Y，Z对治疗某疾病的疗效，我们将实验对象分成三组，分别记录服用X，Y，Z三种药物的治疗效果，并依次得到三组样本如下：

         X1,X2,X3,⋯,Xn1;
  
         Y1,Y2,Y3,⋯,Yn2;
  
         Z1,Z2,Z3,⋯,Zn3;
 
通过这些实验数据，我们希望回答：①三种药物对治疗该疾病有没有显著差异；②如果有差异，哪种药物治疗效果最好？

这个例子中，药物称为处理因素，X，Y，Z称为该因素的水平。这个实验只涉及单个处理因素——“药物”，我们称之为单因素实验，对应的方差分析处理叫单因子方差分析(One-way ANOVA)。此外，如果比较不同的药物和 剂量对疗效的影响，这就是双因素实验，对应的方差分析叫双因子方差分析(Two-way ANOVA)，由此类似可推广到多因素实验和多因子方差分析(Multi-way ANOVA)。


### F检验的前提和应用

#### 前提

F-检验是建立在一些假设基础上的，如果你的实验不能满足F-检验的假设，那你需要考虑别的分析方法或者改变实验设计。F-检验有主要有以下3个假设：

    1. 方差的齐性，可以理解为每组样本背后的总体(也叫族群)都有相同的方差
    2. 族群遵循正态分布
    3. 每一次抽样都是独立的，比如每个病人只能提供一个数据。对于一些一个样本需要提供多个数据的情况，有其他相应的F检验方法。

#####  应用

F检验的主要有如下几种： 

1. [方差齐性检验(F-test of equality of variances)](#方差齐性检验) 
2. 方差分析(Analysis of Variance, ANOVA)
3. 线性回归方程整体的显著性检验

### 单因子方差分析

完全随机设计(Completely random design)是采用完全随机化的分组方法，将全部实验对象分配到g个组(水平组)，各组按照设计因素(单因子方差分析,One-way ANOVA) 分别接受不同水平的处理，实验结束后比较各组均数之间的差别有无统计学意义，推论因素的效应。

注意的是，当方差不齐的是否，可以使用oneway.test()函数进行F检验，设置var.equal为FALSE， 此时即为 _Welch_检验。

使用《医学统计学》中的案例4-2的数据在R中进行完全随机设计资料的方差分析测试

例4-2 某医生为研究一种降血脂新药的疗效，按统一纳入标准纳入了120名高血脂的患者，采用完全随机设计将患者分为4组（a:安慰剂；b：低剂量；c：中计量；d：高计量），进行双盲试验，6周后测得低密度脂蛋白结果，问四组患者总体低密度脂蛋白含量有无差别？
```{r}
a <- c(3.53,4.59,4.34,2.66,3.59,3.13,2.64,2.56,3.50,3.25,
3.30,4.04,3.53,3.56,3.85,4.07,3.52,3.93,4.19,2.96,
1.37,3.93,2.33,2.98,4.00,3.55,2.96,4.30,4.16,2.59)

b <- c(2.42,3.36,4.32,2.34,2.68,2.95,1.56,3.11,1.81,1.77,
1.98,2.63,2.86,2.93,2.17,2.72,2.65,2.22,2.90,2.97,
2.36,2.56,2.52,2.27,2.98,3.72,2.80,3.57,4.02,2.31)

c <- c(2.86,2.28,2.39,2.28,2.48,2.28,3.21,2.23,2.32,2.68,
2.66,2.32,2.61,3.64,2.58,3.65,2.66,3.68,2.65,3.02,
3.48,2.42,2.41,2.66,3.29,2.70,3.04,2.81,1.97,1.68)

d <- c(0.89,1.06,1.08,1.27,1.63,1.89,1.19,2.17,2.28,1.72,
1.98,1.74,2.16,3.37,2.97,1.69,0.94,2.11,2.81,2.52,
1.31,2.51,1.88,1.41,3.19,1.92,2.47,1.02,2.10,3.71)

ldlc <- cbind(a,b,c,d)
library(reshape2)
ldlc <- melt(ldlc,
             id.vars = c(''),
             value.name = '低密度脂蛋白')
library(plyr)
ldlc <- rename(ldlc,
               c(Var2='分组'))
序号 <- c(1:120)
ldlc <- cbind(ldlc,序号)
ldlc <- subset(ldlc,select = -1)
str(ldlc)
 library(reactable)
reactable(
  ldlc[1:120, ],
  height = 270,
  striped = TRUE,
  defaultColDef = colDef(
    footer = function(values, name) htmltools::div(name, style = list(fontWeight = 600))
  )
)
```


```{r}
#使用tableone包计算
#install.package(tableone)
library(tableone)
shapiro.test(ldlc$低密度脂蛋白)#服从正态
ldlc_var <- CreateTableOne(ldlc,vars = c('低密度脂蛋白'),strata = '分组')
 print(ldlc_var)#若不服从正态nonnormal = c('低密度脂蛋白')

```


```{r}
#对不规则数组应用指定的函数，快速计算每组的均值，方差，和样本大小
tapply(ldlc$低密度脂蛋白,ldlc$分组,mean)
tapply(ldlc$低密度脂蛋白,ldlc$分组,var)
## 使用oneway.test()函数进行F检验，注意var.equal 默认是 FALSE，也就是说方差可以不相等(此时即为Welch检验)，但是提供的信息相对较少。
oneway.test(ldlc$低密度脂蛋白 ~ ldlc$分组,var.equal=T)
oneway.test(ldlc$低密度脂蛋白 ~ ldlc$分组,var.equal=F)
#使用aov()函数进行F检验，可以获取完整地参数信息，这里要注意aov()里面提供的group信息
#最好不要是数值形式的分组，否则结果容易当作线性回归处理，导致与预期不一致，可以用
#as.character()将数字转换为字串形式的再使用
ldlc_aov <- aov(ldlc$低密度脂蛋白 ~ as.character(ldlc$分组))

summary(ldlc_aov)
##其他几个查看aov()对象的工具
summary.aov(ldlc_aov)
summary.lm(ldlc_aov)
TukeyHSD(ldlc_aov)

boxplot(ldlc$低密度脂蛋白 ~ ldlc$分组,col=c(2:5),ylab="低密度脂蛋白 ",xlab="分组")
```

### 随机区组设计方差分析

随机区组设计(Randomized block design)又称为配伍组设计，是配对设计的扩展。具体做法是:先按影响实验结果的 非处理因素(如性别、体重、年龄、职业、病情、病程等)将实验对象配成区组(Block)，再分 别将各区组内的实验对象 随机分配到各处理组或对照组。与完全随机设计相比，随机区组设计的特点是 随机分配的次数要重复多次，每次随机分 配都对同一个区组内的实验对象进行，**且各个处理组的实验对象数量相同，区组内均衡。**在进行统计分析时，将区组 变异离均差平方和从完全随机设计的组內离均差平和 中分离出来，从而减小组内离均差平方和(误差平方和)，提高统 计检验效率。若将区组作为另一处理因素 的不同水平，随机区组设计等同于无重复观察的两因素设计(双因子方差分析,Two-way ANOVA)

随机区组设计资料在进行统计分析时，需根据数据的分布特征选择方法，对于正态分布且方差齐同的资料，采用双向分类的 方差分析(Two-way classification ANOVA)或配对t检验(g=2)；当不满足方差分析或t检验条件时，可进行变量变换后采 用双向分类的方差分析或采用Friedman M检验。


双向ANOVA分析是单向ANOVA的扩展，分析两个因素，我们称之为A和B，假如A有i(1$_g$)个水平(或叫区组)，B有j(1$_n$)个水平(处理因素的水平)， 且每个分组的样本数目要一致，则共有 N=ng 样本个体，记总均数为 $\overline x$
 ，各处理组均数分别是 $\overline x$$_i$ ， 各区组均数为 $\overline x$$_i$，双向ANOVA的实验数据有四个不同的变异：
 
 1. 总变异，它反应所有观测值之间的变异，总离均差平方和：SS$_t$$_o$$_t$$_a$$_l$

2. 处理组间变异，它反应处理因素的不同水平作用和随机误差产生的变异：SS$_t$$_r$$_e$$_a$$_t$

3. 区组间变异，它反应不同区组作用和随机误差产生的变异：SS$_b$$_l$$_o$$_c$$_k$

4. 误差变异，它是完全由随机误差产生的变异： SS$_e$$_r$$_r$$_o$
 
 对总离均差平方和及自由度的分解关系为：
 
 
 SS$_t$$_o$$_t$$_a$$_l$=SS$_t$$_r$$_e$$_a$$_t$+SS$_b$$_l$$_o$$_c$$_k$+SS$_e$$_r$$_r$$_o$


 v$_t$$_o$$_t$$_a$$_l$=v$_t$$_r$$_e$$_a$$_t$+v$_b$$_l$$_o$$_c$$_k$+v$_e$$_r$$_r$$_o$

双向ANOVA能够同时检验3个零假设：

1. 单独考虑A因素，总体均值间没有差别，这相当于对A因子进行单向ANOVA

2. 单独考虑B因素，总体均值间没有差别，这相当于对B因子进行单向ANOVA

3. A和B两个因素，没有相互作用，相当于使用二联表进行独立性分析

使用《医学统计学》中的 案例4-4 的数据在R中进行双因子方差分析的测试。

例4-4 某研究者采用随机区组设计进行实验，比较三种抗癌药物对小白鼠肉瘤的抑瘤效果，先将15只染有肉瘤小白鼠按体重大小配成5个区组每个区组内3只小白鼠随机接受三种抗癌药物，以肉瘤的重量为指标。问三种不同药物的抑瘤效果有无差别?
```{r}

quzu <- c(1:5)
drug_a <- c(0.82,0.73,0.43,0.41,0.68)
drug_b <- c(0.65,0.54,0.34,0.21,0.43)
drug_c <- c(0.51,0.23,0.28,0.31,0.24)

drug <- cbind(quzu,drug_a,drug_b,drug_c)
library(reshape2)
drug <- melt(drug,
             id.vars = c(''))
library(plyr)
drug <- rename(drug,
               c(Var1='区组',Var2='药物',value = '肿瘤重量'))

drug <- drug[6:20,]
str(drug)
 library(reactable)
reactable(
  drug[1:15, ],
  height = 250,
  striped = TRUE,
  defaultColDef = colDef()
  )
drug_aov <- aov(肿瘤重量~factor(drug$区组)+药物, drug)
drug_aov
summary(drug_aov)

summary.aov(drug_aov)
summary.lm(drug_aov)
TukeyHSD(drug_aov)


```
根据计算结果，对于处理组间F值为11.937，对应P值是0.004<0.01<α=0.05，因此拒绝处理组间 H0:μ1=μ2=μ3 的原假设，接受 H1 ，即认为 药物的肿瘤生长有统计学意义。同理，区组间的F值为5.978，对应的P值是0.0158<α=0.05，因此拒绝区组间的 H0:μ1=μ2=μ3 的原假设， 接受 H1，即体重对肿瘤生长的影响有统计学意义。


现在有一个问题，是方差分析的结果可以推断多组样本的总体之间的均值是否都相等，如果不都相等，我怎么知道是具体是怎么不相等的呢？ 详细请看多重比较。(#多重比较)

###  拉丁方设计资料的方差分析

完全随机设计只涉及一个处理因素；随机区组设计涉及一个处理因素、一个区组因素(或称为配伍因素)； 倘若实验研究涉及一个处理因素和两个控制因素，每个因素的类别数或水平数相等，此时可采用拉丁方 设计(Latin square design)来安排实验，将两个控制因素分别安排在拉丁方设计的行和列上。拉丁方 设计是在随机区组设计的基础上发展的，它可多安排一个已知的对实验结果有影响的非处理 因素，增加 了均衡性，减少了误差，提高了效率。


拉丁方设计资料采用三向分类的ANOVA，由于比较复杂，在分析之前应该理清楚处理组，列区组。行区组的 对应的因素，并理清它们各自的原假设与备择假设，总的来说能够同时检验3个零假设：

1. 处理组之间的总体均数都相等

2. 列区组之间的总体均数都相等

3. 行区组之间的总体均数都相等

使用《医学统计学》中的 案例4-5 的数据在R中进行拉丁方实验设计资料的方差分析测试。

下面通过例4-5介绍拉丁方设计。
例4-5某研究者为了比较甲、乙、丙丁戊、己6种药物给家兔注射后产生的皮肤疱疹大小(mm)采用拉丁方设计，选用6只家兔并在每只家兔的6个不同部位进行注射。试作方差分析。其设计步骤如下:
(1)本研究药物是处理因素，家兔和部位是减少实验误差的控制因素，这三个因素的水平数都为6.从专业上判断因素间相互作用的影响可忽略，故可选择拉丁方设计。
(2)g=6，选定6x6基本拉丁方。
(3)行区组代表不同的家兔，列区组代表不同的注射部位，拉丁字母代表不同的药物

```{r}
rabit_num <- sort(rep(c(1:6),6))#家兔编号
injection_site <-rep(c(1:6),6)#注射部位
treatment_durg <- c('c','b','e','d','a','f','b','a','d','c','f','e','f',
                    'e','b','a','d','c','a','f','c','b','e','d','d','c','f','e','b','a','e','d','a','f','c','b')#治疗药物

herpes_size <- c(87,75,81,75,84,66,73,81,87,85,64,79,73,73,74,78,73,77,77,68,69,74,76,73,64,64,72,76,70,81,75,77,82,61,82,61)#疱疹大小

study_4.5<- cbind(rabit_num,injection_site,herpes_size,treatment_durg)
study_4.5 <- as.data.frame(study_4.5)
study_4.5$rabit_num <- as.factor(study_4.5$rabit_num)
study_4.5$injection_site <- as.factor(study_4.5$injection_site)
study_4.5$treatment_durg <- as.factor(study_4.5$treatment_durg)
study_4.5$herpes_size <- as.numeric(study_4.5$herpes_size)
str(study_4.5)

 library(reactable)
reactable(
  study_4.5[1:36, ],
  height = 270,
  striped = TRUE,
  defaultColDef = colDef()
  )
study_4.5_aov <- aov(herpes_size~rabit_num+injection_site+treatment_durg, study_4.5)
study_4.5_aov
summary(study_4.5_aov)

```

根据计算结果，对于处理组间F值为3.79402，对应P值是0.014<α=0.05，因此拒绝处理组间 
H
0
 的原假设，接受 
H
1
 ，即认为 6种药物的对疱疹大小的生长影响有统计学意义。同理，家兔间的F值为1.42444，对应的P值是0.258401>α=0.05，因此暂时不能拒绝家兔间的 
H
0
 的原假设， 即还不能认为疱疹的大小的总体均数不全相等。对于部位间的F值为0.37157，对应的P值是0.862102>α=0.05，因此暂时不能拒绝部位间的 
H
0
 的原假设， 即还不能认为6个部位的疱疹大小的总体均数不全相等。
```{r}
summary.aov(study_4.5_aov)
summary.lm(study_4.5_aov)
TukeyHSD(study_4.5_aov)

```

###  两阶段交叉设计资料的方差分析

在医学研究中，欲将A、B两种处理先后施加于同一批实验对象，随机地使半数实验对象先接受A后 接受B，而另一半实验对象 则正好相反，即先接受B再接受A。由于两种处理在全部实验过程中交叉进 行，这种设计称为交叉设计(Crossover design)。 在交叉设计中，A、B两种处理先后以同等的机会出现在两 个实验阶段中，故又称为两阶段交叉设计。当然也可以有多个实验 阶段，但本节仅介绍两阶段的交叉设 计。虽然交叉实验的处理是单因素，但影响实验结果的因素还有非人为控制的实验对 象的个体差异和实 验阶段这两个因素。因此，该设计不仅平衡了处理顺序的影响，而且能把处理方法间的差别、时间先后之 间的差别和实验对象之间的差别分开来分析。但是该设计有一个较为严格的限制条件：前一个实验阶段的处理效应不能持续 作用到下一个实验阶段。为此，有必要在两个阶段之间设一个洗脱(Wash-out)阶段， 以消除残留效应(Carry-over effect) 的影响。在医学研究中交叉设计多用于止痛、镇静、降压等药物或治疗方法间疗效的比较。

使用《医学统计学》中的 案例4-5 的数据在R中进行两阶段交叉设计资料的方差分析测试。

例4-6 该数据是A、B两种闪烁液测定血浆中3H-cGMP的交叉试验结果。第I阶段1、3、4、7、9号用A测定，2、5、6、8、10号用B测定;第Ⅱ阶段1347、9号用B测定25、6、8、10号用A测定。试对交叉试验结果进行方差分析

```{r}
subject <- c(1:10)#受试者，1-10共10人
stage <- c(1,2)#阶段，分为第一阶段和第二阶段
liquid <- c(a,b)#闪烁液体，分为a,b
hcgmp <- c()#3H-cGMP结果


```

## 多个样本均数间的多重比较

当方差分析的结果为拒绝 
H
0
 ，接受 
H
1
 时，只说明g个总体均数不全相等。若想进一步了解哪两个总体均数不等， 须进行多个样本均数间的两两比较或称多重比较(Multiple comparison)。这种进一步阐明在ANOVA测试中起重要作 用的群体差异的方法，叫做事后测试(Post hoc tests)。如用案例4-2 的两样本均数比较的检验进行 多重比较，将会加大犯I型错误(把总体均数间本无差别判为有差别)的概。若用t检验作6次比较，且每次比较的检验 水准选为α=0.05，则每次比较不犯I类错误的概率为(1-0.05)，6次均不犯I类错误的概率为(1-0.05)，这时， 总的检验水准变为1-(1-0.05)=026，比0.05大多了。因此，样本均数间的多重比较不能用两样本均数比较的检验。

事后测试分析测试非常重要，因为尽管ANOVA提供了很多信息，但它并未提供有关特定研究组之间差异的详细信息，也无法提供有关复杂比较的信息。 这些事后测试的进一步分析可能会为研究人员提供该研究的最重要发现。可供我们选择的事后测试统计方法更有10多种， 但是目前还没有一种在任何条件下都适用、效果好的方法。因此，选择与数据相匹配的测试方法，进行组间比较有关的信 息种类以及必要的分析就非常重要。方法选择不当的后果通常与第Ⅰ类错误有关，但也可能涉及未能发现组之间的重要差异。 进一步了解可以阅读：





## 多样本方差齐性检验

在进行方差分析时要求所对比的各组即各样本的总体方差必须是相等的，这一般需要在作方差分析之前，先对资料的方差齐性进行检验， 特别是在样本方差相差悬殊时，应注意这个问题。对两总体方差进行齐性检验的方法前已介绍。本节介绍多样本(也适用于两样本)方差比较的 Bartlett’s 检验和Levene’s 检验。

### Bartlett’s 检验

该检验以Maurice Stevenson Bartlett命名的，是基于其抽样分布近似为具有(k-1)自由度的卡方分布的统计量，其中k是随机样本的数量， 其大小可能有所不同，并且每个样本均来自独立的正态分布。 巴特利特的检验对偏离常态很敏感，如果样本来自非正态分布， 那么Bartlett的检验可能就比较差。Levene检验和Brown-Forsythe检验是Bartlett检验的替代方法，对偏离正态性较不敏感。


在R语言中的实现，可以参考下面的代码，以案例4-2数据做测试。根据计算结果，P值=0.1564>0.1，方差齐性检验的通常按照α=-。1 设置，因此不拒绝 
H0 ，即不拒绝各组之间的方向都相等。
```{r}
bartlett.test(study_4.5$herpes_size,study_4.5$treatment_durg)
```

### Levene’s 检验

Levene’s 检验是Bartlett’s 检验的替代方法，对样本整体数据不必要是正态分布,对偏离正态性较不敏感。与Levene’s 检验相似的 还有Brown–Forsythe检验，两者的区别是用来计算各组的中心取得参数不一样，Brown–Forsythe采用的是中位数(median)，Levene’s是均值(mean)。

在R语言中的实现，可以参考下面的代码，以案例4-2数据做测试。根据计算结果，P值=0.1564>0.1，方差齐性检验的通常按照α=-。1 设置，因此不拒绝 
H
0
 ，即不拒绝各组之间的方向都相等
 
```{r}
#DescTools包中的LeveneTest()
library(DescTools)
#Levene's是均值(mean)，center = "mean"
LeveneTest(study_4.5$herpes_size,study_4.5$treatment_durg,center = "mean")

#Brown–Forsythe 是中位数(median)，center = "median"
LeveneTest(study_4.5$herpes_size,study_4.5$treatment_durg,center = "median")
```
## 重复测量的方差分析
 
 
 
 














